<%- include('partials/header', {title: announcement.title, user: user}) %>

<div class="container" style="max-width: 1200px; margin: 0 auto; padding: 2rem 1rem;">
    <!-- Bouton retour -->
    <div style="margin-bottom: 2rem;">
        <a href="/" style="color: #8b4513; text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-arrow-left"></i> Retour à l'accueil
        </a>
    </div>

    <div class="announcement-details" style="display: grid; grid-template-columns: 1fr 1fr; gap: 3rem; align-items: start;">
        
        <!-- Galerie d'images -->
        <div class="image-gallery">
            <% if (announcement.images && announcement.images.length > 0) { %>
                <!-- Image principale avec navigation -->
                <div class="main-image" style="margin-bottom: 1rem; position: relative;">
                    <img id="mainImage" 
                         src="/uploads/<%= announcement.images[0] %>" 
                         alt="<%= announcement.title %>"
                         style="width: 100%; height: 400px; object-fit: cover; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.1);">
                    
                    <!-- Boutons de navigation (visibles seulement s'il y a plusieurs images) -->
                    <% if (announcement.images.length > 1) { %>
                        <button id="prevBtn" onclick="previousImage()" 
                                style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%; width: 50px; height: 50px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; transition: background 0.3s;"
                                onmouseover="this.style.background='rgba(0,0,0,0.9)'"
                                onmouseout="this.style.background='rgba(0,0,0,0.7)'">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button id="nextBtn" onclick="nextImage()" 
                                style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%; width: 50px; height: 50px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; transition: background 0.3s;"
                                onmouseover="this.style.background='rgba(0,0,0,0.9)'"
                                onmouseout="this.style.background='rgba(0,0,0,0.7)'">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                        
                        <!-- Indicateur de position -->
                        <div id="imageCounter" style="position: absolute; bottom: 15px; right: 15px; background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.9rem;">
                            1 / <%= announcement.images.length %>
                        </div>
                    <% } %>
                </div>
                
                <!-- Miniatures -->
                <% if (announcement.images.length > 1) { %>
                    <div class="thumbnails" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 0.5rem;">
                        <% announcement.images.forEach((image, index) => { %>
                            <img src="/uploads/<%= image %>" 
                                 alt="Photo <%= index + 1 %>"
                                 onclick="changeMainImage('/uploads/<%= image %>', <%= index %>)"
                                 data-index="<%= index %>"
                                 class="thumbnail <%= index === 0 ? 'active' : '' %>"
                                 style="width: 100%; height: 80px; object-fit: cover; border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: border-color 0.3s;"
                                 onmouseover="this.style.borderColor='#8b4513'"
                                 onmouseout="if(!this.classList.contains('active')) this.style.borderColor='transparent'">
                        <% }) %>
                    </div>
                <% } %>
            <% } else { %>
                <!-- Image par défaut si pas d'image -->
                <div style="width: 100%; height: 400px; background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                    <div style="text-align: center; color: #6c757d;">
                        <i class="fas fa-image" style="font-size: 4rem; margin-bottom: 1rem;"></i>
                        <p>Aucune image disponible</p>
                    </div>
                </div>
            <% } %>
        </div>

        <!-- Informations de l'annonce -->
        <div class="announcement-info">
            <!-- Titre et prix -->
            <div style="margin-bottom: 2rem;">
                <h1 style="color: #8b4513; margin-bottom: 1rem; font-size: 2.5rem;">
                    <%= announcement.title %>
                </h1>
                <div style="background: linear-gradient(135deg, #8b4513, #d2691e); color: white; padding: 1rem 1.5rem; border-radius: 12px; display: inline-block;">
                    <span style="font-size: 2rem; font-weight: bold;">
                        <i class="fas fa-coins"></i> <%= announcement.price.toFixed(2) %> DH
                    </span>
                    <small style="opacity: 0.9; display: block; margin-top: 0.25rem;">Prix fixé par notre expert</small>
                </div>
            </div>

            <!-- Description -->
            <div style="margin-bottom: 2rem;">
                <h3 style="color: #8b4513; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-scroll"></i> Description
                </h3>
                <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 12px; border-left: 4px solid #8b4513;">
                    <p style="line-height: 1.6; margin: 0; white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word; word-break: break-word; max-width: 100%;"><%= announcement.description %></p>
                </div>
            </div>

            <!-- Informations du vendeur -->
            <div style="margin-bottom: 2rem;">
                <h3 style="color: #8b4513; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-user"></i> Vendeur
                </h3>
                <div style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #8b4513, #d2691e); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem; font-weight: bold;">
                            <%= announcement.author_name.charAt(0).toUpperCase() %>
                        </div>
                        <div>
                            <p style="margin: 0; font-weight: bold; color: #333;"><%= announcement.author_name %></p>
                            <p style="margin: 0; color: #666; font-size: 0.9rem;">Membre de notre marketplace</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Informations sur l'annonce -->
            <div style="margin-bottom: 2rem;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div style="background: #e8f4f8; padding: 1rem; border-radius: 8px; text-align: center;">
                        <i class="fas fa-calendar" style="color: #8b4513; font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
                        <p style="margin: 0; font-size: 0.9rem; color: #666;">Publié le</p>
                        <p style="margin: 0; font-weight: bold; color: #333;">
                            <%= new Date(announcement.validated_at || announcement.created_at).toLocaleDateString('fr-FR') %>
                        </p>
                    </div>
                    <div style="background: #e8f4f8; padding: 1rem; border-radius: 8px; text-align: center;">
                        <i class="fas fa-check-circle" style="color: #28a745; font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
                        <p style="margin: 0; font-size: 0.9rem; color: #666;">Statut</p>
                        <p style="margin: 0; font-weight: bold; color: #28a745;">Validé</p>
                    </div>
                </div>
            </div>

            <!-- Bouton de contact -->
            <div style="margin-bottom: 2rem;">
                <button onclick="showContactInfo()" 
                        style="background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; padding: 1rem 2rem; border-radius: 12px; font-size: 1.1rem; font-weight: bold; cursor: pointer; width: 100%; display: flex; align-items: center; justify-content: center; gap: 0.5rem; transition: transform 0.3s, box-shadow 0.3s;"
                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(40, 167, 69, 0.3)'"
                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                    <i class="fas fa-envelope"></i> Contacter le vendeur
                </button>
            </div>

            <!-- Zone de contact (cachée initialement) -->
            <div id="contactInfo" style="display: none; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 12px; padding: 1.5rem;">
                <h4 style="color: #155724; margin-bottom: 1rem;">
                    <i class="fas fa-envelope"></i> Informations de contact - Administration
                </h4>
                <p style="margin-bottom: 0.5rem; color: #155724;">
                    <strong>Email :</strong> admin@antiquites.com
                </p>
                <p style="margin-bottom: 0.5rem; color: #155724;">
                    <strong><i class="fas fa-phone"></i> Téléphone :</strong> 
                    <a href="tel:+212600000000" style="color: #155724; text-decoration: none;">
                        +212 6 00 00 00 00
                    </a>
                </p>
                <p style="margin-bottom: 0.5rem; color: #155724; font-size: 0.9rem;">
                    <strong><i class="fas fa-user"></i> Vendeur :</strong> <%= announcement.author_name %>
                </p>
                <p style="margin: 0; color: #155724; font-size: 0.9rem;">
                    <i class="fas fa-info-circle"></i> Contactez notre administration pour toute question ou pour organiser une visite.
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Version mobile responsive -->
<style>
@media (max-width: 768px) {
    .announcement-details {
        grid-template-columns: 1fr !important;
        gap: 2rem !important;
    }
    
    .thumbnails {
        grid-template-columns: repeat(4, 1fr) !important;
    }
    
    h1 {
        font-size: 2rem !important;
    }
}
</style>

<script>
// Variables globales pour la navigation des images
let currentImageIndex = 0;
let images = [];

// Initialiser les images au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    // Récupérer toutes les miniatures pour construire la liste des images
    const thumbnails = document.querySelectorAll('.thumbnail');
    images = Array.from(thumbnails).map(thumb => thumb.src);
    
    // Si pas de miniatures, récupérer l'image principale
    if (images.length === 0) {
        const mainImg = document.getElementById('mainImage');
        if (mainImg && mainImg.src) {
            images = [mainImg.src];
        }
    }
    
    updateImageCounter();
    
    // Animation d'entrée
    const elements = document.querySelectorAll('.announcement-details > *');
    elements.forEach((el, index) => {
        el.style.opacity = '0';
        el.style.transform = 'translateY(20px)';
        setTimeout(() => {
            el.style.transition = 'opacity 0.5s, transform 0.5s';
            el.style.opacity = '1';
            el.style.transform = 'translateY(0)';
        }, index * 200);
    });
});

// Changer l'image principale
function changeMainImage(imageSrc, index = null) {
    document.getElementById('mainImage').src = imageSrc;
    
    if (index !== null) {
        currentImageIndex = index;
        updateImageCounter();
        updateActiveThumbnail();
    } else {
        // Trouver l'index de l'image
        currentImageIndex = images.indexOf(imageSrc);
        updateImageCounter();
        updateActiveThumbnail();
    }
}

// Navigation précédente
function previousImage() {
    if (images.length > 1) {
        currentImageIndex = currentImageIndex > 0 ? currentImageIndex - 1 : images.length - 1;
        changeMainImage(images[currentImageIndex], currentImageIndex);
    }
}

// Navigation suivante
function nextImage() {
    if (images.length > 1) {
        currentImageIndex = currentImageIndex < images.length - 1 ? currentImageIndex + 1 : 0;
        changeMainImage(images[currentImageIndex], currentImageIndex);
    }
}

// Mettre à jour le compteur d'images
function updateImageCounter() {
    const counter = document.getElementById('imageCounter');
    if (counter && images.length > 1) {
        counter.textContent = `${currentImageIndex + 1} / ${images.length}`;
    }
}

// Mettre à jour la miniature active
function updateActiveThumbnail() {
    const thumbnails = document.querySelectorAll('.thumbnail');
    thumbnails.forEach((thumb, index) => {
        if (index === currentImageIndex) {
            thumb.classList.add('active');
            thumb.style.borderColor = '#8b4513';
        } else {
            thumb.classList.remove('active');
            thumb.style.borderColor = 'transparent';
        }
    });
}

// Navigation au clavier
document.addEventListener('keydown', function(e) {
    if (images.length > 1) {
        if (e.key === 'ArrowLeft') {
            previousImage();
        } else if (e.key === 'ArrowRight') {
            nextImage();
        }
    }
});

// Afficher les informations de contact
function showContactInfo() {
    const contactInfo = document.getElementById('contactInfo');
    if (contactInfo.style.display === 'none') {
        contactInfo.style.display = 'block';
        contactInfo.scrollIntoView({ behavior: 'smooth', block: 'center' });
    } else {
        contactInfo.style.display = 'none';
    }
}
</script>

<%- include('partials/footer') %>
