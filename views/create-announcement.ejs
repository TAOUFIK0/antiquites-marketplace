<%- include('partials/header', {title: 'Créer une annonce', user: {isAdmin: false}}) %>

<div class="form-container">
    <div style="text-align: center; margin-bottom: 2rem;">
        <i class="fas fa-plus-circle" style="font-size: 3rem; color: #8b4513; margin-bottom: 1rem;"></i>
        <h2 style="color: #8b4513; margin-bottom: 0.5rem;">Créer une annonce</h2>
        <p style="color: #666;">Partagez votre antiquité avec notre communauté</p>
    </div>

    <% if (typeof error !== 'undefined' && error) { %>
        <div class="alert alert-error">
            <i class="fas fa-exclamation-triangle"></i> <%= error %>
        </div>
    <% } %>

    <form method="POST" action="/create-announcement" enctype="multipart/form-data">
        <div class="form-group">
            <label for="title">
                <i class="fas fa-heading"></i> Titre de l'antiquité *
            </label>
            <input type="text" id="title" name="title" class="form-control" required 
                   placeholder="Ex: Vase Ming du 15ème siècle" maxlength="100">
        </div>

        <div class="form-group">
            <label for="phone">
                <i class="fas fa-phone"></i> Numéro de téléphone *
            </label>
            <input type="tel" id="phone" name="phone" class="form-control" required 
                   placeholder="Ex: 06 12 34 56 78" pattern="[0-9\s\-\+\(\)\.]{10,15}">
            <small style="color: #888; font-size: 0.9rem;">
                Format accepté : 06 12 34 56 78 ou +33 6 12 34 56 78
            </small>
        </div>

        <div class="form-group">
            <label for="description">
                <i class="fas fa-align-left"></i> Description détaillée *
            </label>
            <textarea id="description" name="description" class="form-control" required 
                      placeholder="Décrivez votre antiquité : époque, matériaux, histoire, état de conservation..." 
                      rows="6" maxlength="1000"></textarea>
            <small style="color: #888; font-size: 0.9rem;">
                <span id="charCount">0</span>/1000 caractères
            </small>
        </div>

        <div class="form-group">
            <label for="images">
                <i class="fas fa-camera"></i> Photos de l'antiquité (max 5)
            </label>
            <input type="file" id="images" name="images" class="form-control" 
                   accept="image/*" multiple onchange="previewImages(this)">
            <small style="color: #888; font-size: 0.9rem;">
                Formats acceptés : JPG, PNG, GIF (max 5MB par image, max 5 images)
            </small>
        </div>

        <div id="imagePreview" style="display: none; margin-top: 1rem;">
            <p style="margin-bottom: 0.5rem; font-weight: bold; color: #8b4513;">Aperçu :</p>
            <div id="previewContainer" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                <!-- Les images d'aperçu seront ajoutées ici -->
            </div>
            
            <!-- Bouton pour ajouter d'autres photos -->
            <div style="margin-top: 1rem; text-align: center;">
                <button type="button" onclick="addMorePhotos()" 
                        style="background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; display: inline-flex; align-items: center; gap: 0.5rem; font-weight: 500; cursor: pointer; transition: transform 0.3s, box-shadow 0.3s;"
                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(40, 167, 69, 0.3)'"
                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                    <i class="fas fa-plus"></i> Ajouter d'autres photos
                </button>
                <small style="display: block; margin-top: 0.5rem; color: #666;">
                    <span id="photoCount">0</span>/5 photos sélectionnées
                </small>
            </div>
        </div>

        <div style="background-color: #e8f4f8; padding: 1.5rem; border-radius: 8px; margin: 1.5rem 0;">
            <h4 style="color: #0c5460; margin-bottom: 1rem;">
                <i class="fas fa-info-circle"></i> Processus de validation
            </h4>
            <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 200px;">
                    <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                        <span style="background: #8b4513; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; margin-right: 0.5rem; font-size: 0.8rem;">1</span>
                        <span style="font-weight: bold;">Soumission</span>
                    </div>
                    <p style="margin: 0; font-size: 0.9rem; color: #666;">Votre annonce est créée</p>
                </div>
                <div style="flex: 1; min-width: 200px;">
                    <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                        <span style="background: #8b4513; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; margin-right: 0.5rem; font-size: 0.8rem;">2</span>
                        <span style="font-weight: bold;">Validation</span>
                    </div>
                    <p style="margin: 0; font-size: 0.9rem; color: #666;">L'admin définit le prix</p>
                </div>
                <div style="flex: 1; min-width: 200px;">
                    <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                        <span style="background: #8b4513; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; margin-right: 0.5rem; font-size: 0.8rem;">3</span>
                        <span style="font-weight: bold;">Publication</span>
                    </div>
                    <p style="margin: 0; font-size: 0.9rem; color: #666;">Visible sur l'accueil</p>
                </div>
            </div>
        </div>

        <button type="submit" class="btn" style="width: 100%; margin-bottom: 1rem;">
            <i class="fas fa-paper-plane"></i> Soumettre mon annonce
        </button>
    </form>

    <div style="text-align: center; margin-top: 1rem;">
        <a href="/dashboard" style="color: #888; text-decoration: none;">
            <i class="fas fa-arrow-left"></i> Retour au tableau de bord
        </a>
    </div>
</div>

<script>
// Compteur de caractères
document.getElementById('description').addEventListener('input', function() {
    const count = this.value.length;
    document.getElementById('charCount').textContent = count;
    
    if (count > 900) {
        document.getElementById('charCount').style.color = '#dc3545';
    } else if (count > 800) {
        document.getElementById('charCount').style.color = '#ffc107';
    } else {
        document.getElementById('charCount').style.color = '#888';
    }
});

// Aperçu des images multiples
let selectedFiles = []; // Stocker les fichiers sélectionnés

function previewImages(input) {
    const preview = document.getElementById('imagePreview');
    const previewContainer = document.getElementById('previewContainer');
    
    if (input.files && input.files.length > 0) {
        // Ajouter les nouveaux fichiers aux fichiers existants
        Array.from(input.files).forEach(file => {
            // Vérifier si le fichier n'est pas déjà sélectionné
            const isDuplicate = selectedFiles.some(existingFile => 
                existingFile.name === file.name && existingFile.size === file.size
            );
            
            if (!isDuplicate && selectedFiles.length < 5) {
                selectedFiles.push(file);
            }
        });
        
        // Vérifier le nombre total de fichiers
        if (selectedFiles.length > 5) {
            alert('Maximum 5 images autorisées');
            selectedFiles = selectedFiles.slice(0, 5);
        }
        
        // Réinitialiser l'input pour permettre la sélection du même fichier
        input.value = '';
        
        // Recréer l'affichage complet
        updatePreview();
    }
}

function updatePreview() {
    const preview = document.getElementById('imagePreview');
    const previewContainer = document.getElementById('previewContainer');
    
    // Vider le conteneur
    previewContainer.innerHTML = '';
    
    if (selectedFiles.length > 0) {
        preview.style.display = 'block';
        
        selectedFiles.forEach((file, index) => {
            // Vérifier la taille du fichier (5MB max)
            if (file.size > 5 * 1024 * 1024) {
                alert(`L'image ${file.name} est trop volumineuse (max 5MB)`);
                removeFile(index);
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageDiv = document.createElement('div');
                imageDiv.style.position = 'relative';
                imageDiv.innerHTML = `
                    <img src="${e.target.result}" 
                         style="width: 100%; height: 200px; object-fit: cover; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <div style="position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.7); color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem;">
                        ${index + 1}
                    </div>
                    <button type="button" onclick="removeFile(${index})" 
                            style="position: absolute; top: 5px; left: 5px; background: rgba(220, 53, 69, 0.9); color: white; border: none; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; cursor: pointer;">
                        ×
                    </button>
                `;
                previewContainer.appendChild(imageDiv);
            };
            reader.readAsDataURL(file);
        });
        
        // Mettre à jour l'input file avec les fichiers sélectionnés
        updateFileInput();
    } else {
        preview.style.display = 'none';
    }
    
    // Mettre à jour le compteur de photos
    const photoCount = document.getElementById('photoCount');
    if (photoCount) {
        photoCount.textContent = selectedFiles.length;
    }
}

function removeFile(index) {
    selectedFiles.splice(index, 1);
    updatePreview();
}

function updateFileInput() {
    const input = document.getElementById('images');
    const dt = new DataTransfer();
    
    selectedFiles.forEach(file => {
        dt.items.add(file);
    });
    
    input.files = dt.files;
}

function addMorePhotos() {
    if (selectedFiles.length >= 5) {
        alert('Maximum 5 images autorisées');
        return;
    }
    document.getElementById('images').click();
}
</script>

<%- include('partials/footer') %>
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f8f9fa;
        }
        .preview-image {
            max-width: 100%;
            max-height: 200px;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark" style="background-color: #8B4513;">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-gem me-2"></i>Antiquités Marketplace
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/dashboard">
                    <i class="fas fa-tachometer-alt me-1"></i>Tableau de bord
                </a>
                <a class="nav-link" href="/">
                    <i class="fas fa-home me-1"></i>Accueil
                </a>
                <a class="nav-link" href="/logout">
                    <i class="fas fa-sign-out-alt me-1"></i>Déconnexion
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="form-card p-5">
                    <div class="text-center mb-4">
                        <i class="fas fa-plus-circle fa-3x mb-3" style="color: #8B4513;"></i>
                        <h2 class="fw-bold" style="color: #8B4513;">Créer une Annonce</h2>
                        <p class="text-muted">Partagez votre antiquité avec notre communauté</p>
                    </div>

                    <% if (error) { %>
                        <div class="alert alert-danger" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <%= error %>
                        </div>
                    <% } %>

                    <div class="alert alert-info" role="alert">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Information importante :</strong> Votre annonce sera soumise à validation par notre équipe. 
                        Le prix sera défini par l'administrateur lors de la validation.
                    </div>

                    <form method="POST" action="/create-announcement" enctype="multipart/form-data">
                        <div class="mb-4">
                            <label for="title" class="form-label">
                                <i class="fas fa-heading me-2"></i>Titre de l'antiquité *
                            </label>
                            <input type="text" class="form-control" id="title" name="title" required minlength="3" 
                                   placeholder="Ex: Vase en porcelaine de Limoges du 19ème siècle">
                            <div class="form-text">Minimum 3 caractères</div>
                        </div>

                        <div class="mb-4">
                            <label for="description" class="form-label">
                                <i class="fas fa-align-left me-2"></i>Description détaillée *
                            </label>
                            <textarea class="form-control" id="description" name="description" rows="5" required minlength="10"
                                      placeholder="Décrivez votre antiquité : époque, matériaux, dimensions, état, histoire, etc. Plus votre description est détaillée, mieux c'est !"></textarea>
                            <div class="form-text">Minimum 10 caractères</div>
                        </div>

                        <div class="mb-4">
                            <label for="image" class="form-label">
                                <i class="fas fa-camera me-2"></i>Photo de l'antiquité (optionnel)
                            </label>
                            <input type="file" class="form-control" id="image" name="image" accept="image/*">
                            <div class="form-text">Formats acceptés : JPG, PNG, GIF (max 5MB)</div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label">
                                <i class="fas fa-eye me-2"></i>Aperçu de la photo
                            </label>
                            <div class="preview-area" id="imagePreview">
                                <div class="text-center text-muted">
                                    <i class="fas fa-image fa-3x mb-2"></i>
                                    <p>Aucune image sélectionnée</p>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-sm-6 mb-3">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-paper-plane me-2"></i>Soumettre l'annonce
                                </button>
                            </div>
                            <div class="col-sm-6">
                                <a href="/dashboard" class="btn btn-outline-secondary w-100">
                                    <i class="fas fa-times me-2"></i>Annuler
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Aperçu de l'image
        document.getElementById('image').addEventListener('change', function(event) {
            const file = event.target.files[0];
            const preview = document.getElementById('imagePreview');
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" class="preview-image" alt="Aperçu">`;
                };
                reader.readAsDataURL(file);
            } else {
                preview.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="fas fa-image fa-3x mb-2"></i>
                        <p>Aucune image sélectionnée</p>
                    </div>
                `;
            }
        });
    </script>
</body>
</html>
